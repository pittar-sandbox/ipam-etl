- route:
    id: ipam-poller
    from:
      id: from-file-source
      uri: file
      parameters:
        directoryName: >-
          src/main/resources/samples?recursive=true&noop=true&include=.*.csv&delay=5000
      steps:
        - log:
            id: log-processing-file
            message: "Processing file: ${header.CamelFilePath}"
        - choice:
            id: choice-provider
            when:
              - id: when-bluecat
                expression:
                  simple:
                    id: simple-bluecat-check
                    expression: ${header.CamelFileParent} contains 'bluecat'
                steps:
                  - to:
                      id: to-parse-bluecat
                      uri: direct:parseBlueCat
              - id: when-infoblox
                expression:
                  simple:
                    id: simple-infoblox-check
                    expression: ${header.CamelFileParent} contains 'infoblox'
                steps:
                  - to:
                      id: to-parse-infoblox
                      uri: direct:parseInfoblox
              - id: when-other
                expression:
                  simple:
                    id: simple-other-check
                    expression: ${header.CamelFileParent} contains 'other'
                steps:
                  - to:
                      id: to-parse-other
                      uri: direct:parseOther
            otherwise:
              id: otherwise-unknown
              steps:
                - to:
                    id: to-parse-unknown
                    uri: direct:parseUnknown
- route:
    id: parse-bluecat
    from:
      id: from-parse-bluecat
      uri: direct:parseBlueCat
      steps:
        - log:
            id: log-bluecat
            message: Parsing BlueCat format
        - unmarshal:
            id: unmarshal-bluecat
            csv:
              id: csv-bluecat
        - bean:
            id: process-bluecat
            ref: ipamProcessor
            method: parseBlueCat
        - to:
            id: to-persist-bluecat
            uri: direct:persist
- route:
    id: parse-infoblox
    from:
      id: from-parse-infoblox
      uri: direct:parseInfoblox
      steps:
        - log:
            id: log-infoblox
            message: Parsing Infoblox format
        - bean:
            id: process-infoblox
            ref: ipamProcessor
            method: parseInfoblox
        - to:
            id: to-persist-infoblox
            uri: direct:persist
- route:
    id: parse-other
    from:
      id: from-parse-other
      uri: direct:parseOther
      steps:
        - log:
            id: log-other
            message: Parsing Other format
        - unmarshal:
            id: unmarshal-other
            csv:
              id: csv-other
        - bean:
            id: process-other
            ref: ipamProcessor
            method: parseOther
        - to:
            id: to-persist-other
            uri: direct:persist
- route:
    id: parse-unknown
    from:
      id: from-parse-unknown
      uri: direct:parseUnknown
      steps:
        - log:
            id: log-unknown
            message: "WARN: Unknown format detected. Delegating to AI Service: ${header.CamelFilePath}"
        - bean:
            id: process-unknown
            ref: ipamProcessor
            method: parseUnknown
        - to:
            id: to-persist-unknown
            uri: direct:persist
- route:
    id: persist-mongo
    from:
      id: from-persist
      uri: direct:persist
      steps:
        - choice:
            when:
              - simple: "${body.size()} > 0"
                steps:
                  - log:
                      id: log-persist
                      message: Persisting ${body.size()} records to MongoDB
                  - bean:
                      id: to-documents
                      ref: ipamProcessor
                      method: toDocuments
                  - to:
                      id: to-mongo-endpoint
                      uri: "{{ipam.output.endpoint}}"
            otherwise:
              steps:
                - log:
                    id: log-skip
                    message: "Skipping persistence: No records found"
